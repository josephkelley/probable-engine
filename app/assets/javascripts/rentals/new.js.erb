function isEmpty(str) {
  return (!str || 0 === str.length);
}

function costCalculation(){
  var activeTab = $("div.active").attr('id');
  var raw_item_type = null;
  var raw_start_time = null;
  var raw_end_time = null;
  var amount = null;

  if(activeTab == "single_day") {
    raw_item_type = $('#single_item_type_id').val();
    raw_start_time = $('#single_start_time').val();
    raw_end_time = $('#single_start_time').val(); <% #force it to be one day %>
    amount = $('#single_amount');
  } else { //must be on multiple tab
    raw_item_type = $('#multiple_item_type_id').val();
    raw_start_time = $('#multiple_start_time').val();
    raw_end_time = $('#multiple_end_time').val();
    amount = $('#multiple_amount');
  }

  if(!isEmpty(raw_item_type) && !isEmpty(raw_end_time) && !isEmpty(raw_start_time)) {
    if(new Date(raw_start_time) > new Date(raw_end_time)) {
      alert('Pickup Date must occur before Dropoff date');
    } else {
      $.ajax({
        url: Routes.rentals_cost_path(),
        dataType: 'json',
        data: { item_type: raw_item_type, start_time: raw_start_time, end_time: raw_end_time },
        success: function (data) {
          amount.val(data);
        },
        error: function () {
          alert('failed to retreive rental cost');
        }
      });
    }
  }
}

function userResultHandleClick(e) {
  var userId = e.currentTarget.id.substr(10); //select the user id
  $("#user_id").val(userId); //set user id
  
  var row = $(e.currentTarget.parentNode.parentNode); //select the row
  var name = row.find("td:nth-child(1)").text() + " " + row.find("td:nth-child(2)").text(); //first two td's joined by space
  $("#userSearchQuery").val(name); //set the user to the full name

  $("#modalSearchResults").modal('toggle'); //close modal
}

$(document).ready( function () {
  costCalculation(); //initial cost calculaton

  $('input.cost-dependent').on('blur', function () {
    costCalculation();
  });

  $('select.cost-dependent').on('change', function () {
    costCalculation();
  });

  $("a[href='#multiple_day']").on('shown.bs.tab', function () {
    costCalculation();
  });

  $("input[id$='amount']").change(function () {
    alert('Warning! You are overriding the system defaults.');
  });
  
  //enter key performs click on search
  $("#userSearchQuery").keypress(function (key) {
    if(key.which === 13) {
      $("#userSearchAction").click();
    }
  });

  $("#userSearchAction").click( function () {
    $.ajax({
      url: Routes.rentals_search_users_path(),
      dataType: "html",
      data: { user_search_query: $("#userSearchQuery").val() },
      success: function (data) {
        $("#userResults").html(data); //put content in the modal
        
        //attach event listeners
        $(".userResult").click(userResultHandleClick);
      },
      error: function () {
        alert("Failed to retreive users.");
      }
    });
  });

});
